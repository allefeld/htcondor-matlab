# Submit Matlab jobs to HTCondor from Matlab

*htcondor-matlab* is a set of Matlab functions to interface with the
[HTCondor](http://research.cs.wisc.edu/htcondor/) high-throughput computing
software framework, to submit Matlab functions as jobs.

It is assumed that the HTCondor machines share a filesystem and that all
machines have access to the resources necessary to run the jobs, including an
installation of Matlab. The functions use HTCondor commands and have therefore
to be run on one of the HTCondor machines.

## Installation

Put the *htcondor-matlab* functions into a directory on the Matlab path. Then
copy `condorConfig_template.m` to `condorConfig.m` in the same directory and
edit the copy. At a minimum, adjust the value of `conDir` to point to an
existing and writable directory, the *htcondor-matlab* cluster directory,
which has to be accessible from all HTCondor machines.

## Usage

The code for creating and submitting a cluster of jobs has the following form:

    clusterHandle = condorCreateCluster;
    for i = 1 : 10
       condorAddJob(clusterHandle, @exampleJob, {i}, 1)
    end
    condorSubmitCluster(clusterHandle)

In this example, the resulting cluster consists of 10 jobs, where each job
runs `exampleJob(i)` with values of `i` from 1 to 10. The job function used
here is included as `exampleJob.m` with *htcondor-matlab*. It takes a number
as argument and returns its square; unless the number is a prime, in which
case an error is thrown.

`clusterHandle` is a string of the form `cluster#` where `#` is a sequential
number starting from 0. The handle is assigned to a cluster by:

    clusterHandle = condorCreateCluster

It is used to identify the cluster to all other functions.

A job is defined and added to a cluster by:

    condorAddJob(clusterHandle, jobFun, argIn, numArgOut)

`jobFun` is the function handle of the job function; it can reference an
m-file (including private) as well as an anonymous, local, or nested function.
`argIn` is a cell array containing the arguments to be passed to the job
function, and `numArgOut` is the number of its output arguments.

A cluster of jobs is submitted to HTCondor using:

    condorSubmitCluster(clusterHandle)

After submission, the progress of its jobs can be monitored using:

    condorMonitorCluster(clusterHandle)

This function scans output, error and HTCondor log files of all jobs and
prints overview information at regular intervals. It assumes a specific form
of the output generated by the job function:

    primary message 1
      secondary message 1
      secondary message 2
    primary message 2
      secondary message 3
      secondary message 4

That is, a line with no leading whitespace is considered a ‘primary message’,
a line with leading whitespace a ‘secondary message’. This way, information
about larger processing units in the job can be separated from information
that tracks progress within these units, giving a more fine-grained overview.
The output of `condorMonitorCluster` has tabular form with the following
structure:  
– The first column shows the job ID. Jobs with error messages are marked with
an asterisk, `*`.  
– The second column shows the last primary message.  
– The third column shows the last secondary message since the last primary
message.  
– The fourth column shows the last entry from the HTCondor log (excluding
‘image resize’ messages).

The information is presented as text in the Command Window, or the terminal
window if Matlab is used without GUI. This has the advantage that
`condorMonitorCluster` can also be used under an `ssh` login.

After all jobs in a cluster have finished, their return values can be
retrieved by:

    results = condorGetResults(clusterHandle);

`results` is a cell array with one element per job. For each job, the
corresponding element is a cell array containing the return value(s) of that
job. Instead of or in addition to returning values, job functions can of
course also write their results directly to files.

See also the Matlab `help` of `condorCreateCluster`, `condorAddJob`,
`condorSubmitCluster`, `condorMonitorCluster`, and `condorGetResults`.

## Clusters, jobs, IDs, and handles

*htcondor-matlab* adopts the terminology of HTCondor: A single computation
unit is called a ‘job’, and a group of jobs submitted together is called a
‘cluster’. In HTCondor, a job is also called a ‘process’ after submission, and
it is identified by a label of the form ClusterId.ProcId. Cluster IDs are
integers assigned by HTCondor sequentially on submission, and process IDs are
integers assigned to jobs in the order of the submit description file,
starting from 0 within a cluster.

For technical reasons, the `clusterHandle` assigned by *htcondor-matlab* does
not correspond to HTCondor’s cluster ID, but `condorSubmitCluster` and
`condorMonitorCluster` provide information about HTCondor cluster and process
IDs, so that its tools including
[`condor_q`](http://research.cs.wisc.edu/htcondor/manual/v8.2.3/condor_q.html)
and
[`condor_rm`](http://research.cs.wisc.edu/htcondor/manual/v8.2.3/condor_rm.html)
can be easily used in conjunction.

## Internal data structure

In the *htcondor-matlab* cluster directory, for each cluster a subdirectory is
created with a name identical to its handle, `cluster#`, which contains data
to manage and run the cluster as well as the return values of completed jobs.
To save disk space, it is advisable to delete a subdirectory after the
corresponding cluster is finished and its return values are no longer needed.

Within each cluster subdirectory, the cluster’s HTcondor submit description
file is `submit`. Job-specific data are in files whose name begins with
`job###`, where `###` is the job ID, a number starting from 000. In
particular, `job###_out` contains the standard output of the job, `job###_err`
the standard error, and `job###_log` the HTCondor log.

------------------------------------------------------------------------------

This software was developed with Matlab R2013a and [HTCondor
8.2.3](http://research.cs.wisc.edu/htcondor/manual/v8.2.3/index.html) on
Debian 7.8, but may work with other versions and OSs, too. It is copyrighted ©
2016 by Carsten Allefeld and released under the terms of the GNU General
Public License, version 3 or later.
